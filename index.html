<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MOOC — Listening & Speaking — Benchmark Master</title>
  <style>
    :root{
      --green: #00723f;
      --bg-gradient: linear-gradient(180deg,#071018 0%, #0d1114 100%);
      --panel: #0f1720;
      --muted: #98a0a6;
      --card: #191d22;
      --white: #eef2f3;
      --radius: 12px;
      --shadow: 0 6px 18px rgba(0,0,0,0.45);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg-gradient);color:var(--white);-webkit-font-smoothing:antialiased}
    a{color:var(--green)}
    .wrap{max-width:1100px;margin:28px auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    .brand{font-weight:700}
    .lead{color:var(--muted);margin:6px 0 0 0;font-size:14px;max-width:800px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:18px;border-radius:12px;box-shadow:var(--shadow);margin-bottom:18px}
    h2{margin:0 0 10px 0}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
    .full{grid-column:1/-1}
    input[type="file"]{color:var(--muted)}
    audio{width:100%;border-radius:8px;background:#000}
    textarea{width:100%;min-height:120px;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--white);resize:vertical}
    .btn{background:var(--green);color:#fff;padding:10px 14px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
    .small{font-size:13px;color:var(--muted)}
    .section-title{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .rec-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .meter{height:8px;background:rgba(255,255,255,0.04);border-radius:6px;overflow:hidden;width:140px}
    .meter>i{display:block;height:100%;background:linear-gradient(90deg,#43e175,#0b8a53);width:0%}
    .timer{font-weight:700;color:var(--muted)}
    .submit-wrap{display:flex;justify-content:center;margin-top:18px}
    .note-box{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;color:var(--muted);font-size:13px}
    @media (max-width:900px){
      .grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="brand">Benchmark Master — Listening & Speaking</div>
        <div class="small">Universidad El Bosque</div>
      </div>
      <div>
        <a class="btn" href="index.html">Volver al curso</a>
      </div>
    </header>

    <p class="lead">Página para pruebas de Listening (7 secciones) y Speaking. Sube cada archivo de audio en su sección para que el estudiante lo reproduzca; al final encontrarás las actividades de Writing (parte 1 y 2) y un botón "Submit" para descargar tus respuestas localmente.</p>

    <!-- Listening Sections -->
    <section class="card" aria-labelledby="listeningTitle">
      <div class="section-title">
        <h2 id="listeningTitle">Listening — 7 secciones</h2>
        <div class="small">Sube aquí los audios de cada sección (mp3 / wav / m4a). El estudiante podrá reproducirlos y escribir su respuesta.</div>
      </div>

      <div class="grid" id="listeningGrid">
        <!-- 7 placeholders generated by JS-friendly HTML; each has file input, player, and answer textarea -->
        <!-- We'll include them statically so you can edit if needed -->
        <div>
          <label>Sección 1 — Subir audio</label>
          <input type="file" accept="audio/*" data-section="1" class="audio-upload">
          <div style="margin-top:8px; display:none" data-player-wrap="1">
            <audio controls data-player="1"></audio>
          </div>
          <label style="margin-top:8px">Respuesta / Notas del estudiante</label>
          <textarea placeholder="Respuesta a la sección 1" data-answer="1"></textarea>
        </div>

        <div>
          <label>Sección 2 — Subir audio</label>
          <input type="file" accept="audio/*" data-section="2" class="audio-upload">
          <div style="margin-top:8px; display:none" data-player-wrap="2">
            <audio controls data-player="2"></audio>
          </div>
          <label style="margin-top:8px">Respuesta / Notas del estudiante</label>
          <textarea placeholder="Respuesta a la sección 2" data-answer="2"></textarea>
        </div>

        <div>
          <label>Sección 3 — Subir audio</label>
          <input type="file" accept="audio/*" data-section="3" class="audio-upload">
          <div style="margin-top:8px; display:none" data-player-wrap="3">
            <audio controls data-player="3"></audio>
          </div>
          <label style="margin-top:8px">Respuesta / Notas del estudiante</label>
          <textarea placeholder="Respuesta a la sección 3" data-answer="3"></textarea>
        </div>

        <div>
          <label>Sección 4 — Subir audio</label>
          <input type="file" accept="audio/*" data-section="4" class="audio-upload">
          <div style="margin-top:8px; display:none" data-player-wrap="4">
            <audio controls data-player="4"></audio>
          </div>
          <label style="margin-top:8px">Respuesta / Notas del estudiante</label>
          <textarea placeholder="Respuesta a la sección 4" data-answer="4"></textarea>
        </div>

        <div>
          <label>Sección 5 — Subir audio</label>
          <input type="file" accept="audio/*" data-section="5" class="audio-upload">
          <div style="margin-top:8px; display:none" data-player-wrap="5">
            <audio controls data-player="5"></audio>
          </div>
          <label style="margin-top:8px">Respuesta / Notas del estudiante</label>
          <textarea placeholder="Respuesta a la sección 5" data-answer="5"></textarea>
        </div>

        <div>
          <label>Sección 6 — Subir audio</label>
          <input type="file" accept="audio/*" data-section="6" class="audio-upload">
          <div style="margin-top:8px; display:none" data-player-wrap="6">
            <audio controls data-player="6"></audio>
          </div>
          <label style="margin-top:8px">Respuesta / Notas del estudiante</label>
          <textarea placeholder="Respuesta a la sección 6" data-answer="6"></textarea>
        </div>

        <div>
          <label>Sección 7 — Subir audio</label>
          <input type="file" accept="audio/*" data-section="7" class="audio-upload">
          <div style="margin-top:8px; display:none" data-player-wrap="7">
            <audio controls data-player="7"></audio>
          </div>
          <label style="margin-top:8px">Respuesta / Notas del estudiante</label>
          <textarea placeholder="Respuesta a la sección 7" data-answer="7"></textarea>
        </div>
      </div>
      <div class="note-box" style="margin-top:12px">
        Consejo: Subir cada audio con nombre claro (ej. listening-1.mp3). El archivo se reproduce desde el navegador del estudiante; para uso en GitHub Pages sube los audios a assets/listening/.
      </div>
    </section>

    <!-- Speaking: recording area -->
    <section class="card" aria-labelledby="speakingTitle">
      <div class="section-title">
        <h2 id="speakingTitle">Speaking — Graba tu respuesta</h2>
        <div class="small">Graba una respuesta oral (30–90s recomendado). Puedes descargar la grabación o incluirla junto con el envío.</div>
      </div>

      <label>Prompt para Speaking</label>
      <div class="note-box" style="margin-bottom:10px">
        Habla durante ~60 segundos acerca de las estrategias que sigues para preparar la sección oral de un examen internacional.
      </div>

      <div class="rec-controls">
        <button id="startRec" class="btn">Iniciar grabación</button>
        <button id="stopRec" class="btn ghost" disabled>Detener</button>
        <button id="downloadRec" class="btn ghost" disabled>Descargar</button>
        <div style="margin-left:auto" class="small">Duración: <strong class="timer" id="recDuration">0.0</strong>s</div>
      </div>

      <div style="margin-top:12px;display:none" id="recPlayer">
        <audio id="recAudio" controls></audio>
        <div class="small" id="recMeta"></div>
      </div>

      <div style="margin-top:12px" class="small">Visualizador de volumen</div>
      <div class="meter" aria-hidden="true" style="margin-top:6px"><i id="volLevel"></i></div>
      <div class="note-box" style="margin-top:10px">
        Nota: Si tu navegador no permite grabación, pide al estudiante que grabe localmente y suba el archivo como respuesta (podremos añadir carga en próximas versiones).
      </div>
    </section>

    <!-- Writing section (placed after Listening) -->
    <section class="card" aria-labelledby="writingTitle">
      <div class="section-title">
        <h2 id="writingTitle">Writing — Part 1 & Part 2</h2>
        <div class="small">Parte 1 (paráfrasis) y Parte 2 (ensayo corto). Los tiempos de escritura se inician con los botones correspondientes.</div>
      </div>

      <!-- Part 1 -->
      <div style="margin-bottom:14px">
        <h3 style="margin:0 0 6px 0">Part 1 — Paraphrase (3 minutes)</h3>
        <div class="note-box" id="passageBox">
          <strong>Read the passage carefully. After 30 seconds, it will disappear. Then, rewrite it in your own words.</strong>
          <p style="margin:8px 0 0 0">
            Many people believe that working from home allows employees to be more productive because they can manage their own schedules. However, others think that it reduces teamwork and makes it harder to separate work from personal life.
          </p>
        </div>

        <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
          <button id="startPassage" class="btn">Mostrar 30s (Start)</button>
          <div class="small">Tiempo restante: <strong class="timer" id="passageTimer">00:30</strong></div>
          <div style="margin-left:auto" class="small">Escribe durante: <strong id="writing1Timer" class="timer">03:00</strong></div>
        </div>

        <label style="margin-top:12px">Tu paraphrase (3 minutos)</label>
        <textarea id="writing1" placeholder="Reescribe el pasaje en tus propias palabras..."></textarea>
        <div class="small" style="margin-top:6px">Tiempo recomendado: 3:00 minutos. Se iniciará la cuenta cuando termine la visualización de 30s o al presionar manualmente "Start writing".</div>
      </div>

      <!-- Part 2 -->
      <div>
        <h3 style="margin:0 0 6px 0">Part 2 — Opinion essay (10 minutes)</h3>
        <div class="note-box" style="margin-bottom:8px">
          <strong>Instructions:</strong> Read the question and write your response. You have 10 minutes to write between 75 and 200 words. State your opinion (agree or disagree) and provide at least two reasons/examples.
          <p style="margin:6px 0 0 0"><em>Question:</em> “Children should be allowed to use mobile phones in school.” Do you agree or disagree? Give reasons for your answer.</p>
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <button id="startWriting2" class="btn">Iniciar 10:00</button>
          <div class="small" style="margin-left:auto">Tiempo restante: <strong id="writing2Timer" class="timer">10:00</strong></div>
        </div>

        <label style="margin-top:12px">Tu ensayo (75–200 palabras)</label>
        <textarea id="writing2" placeholder="Escribe tu respuesta aquí..."></textarea>
        <div style="display:flex;gap:12px;margin-top:6px;align-items:center">
          <div class="small">Palabras: <strong id="wordCount">0</strong></div>
          <div class="small">Estado: <strong id="wordState">—</strong></div>
        </div>
      </div>
    </section>

    <div class="submit-wrap">
      <button id="submitAll" class="btn">Submit</button>
    </div>

    <div style="margin-top:18px" class="small">Al presionar Submit se generarán descargas locales con tus respuestas (texto) y la grabación de speaking — así podrás subir/guardar los archivos.</div>
  </div>

  <script>
    // ------------ Listening: load uploaded audio into players --------------
    document.querySelectorAll('.audio-upload').forEach(input => {
      input.addEventListener('change', (ev) => {
        const file = ev.target.files[0];
        const section = ev.target.dataset.section;
        const wrap = document.querySelector(`[data-player-wrap="${section}"]`);
        const player = document.querySelector(`audio[data-player="${section}"]`);
        if(!file) {
          if(player) player.src = '';
          if(wrap) wrap.style.display = 'none';
          return;
        }
        const url = URL.createObjectURL(file);
        player.src = url;
        wrap.style.display = 'block';
      });
    });

    // ------------ Speaking: MediaRecorder basic implementation -------------
    let mediaRecorder = null;
    let recordedChunks = [];
    let startTime = 0;
    let audioContext = null;
    let analyserNode = null;
    let rafId = null;

    const startBtn = document.getElementById('startRec');
    const stopBtn  = document.getElementById('stopRec');
    const downloadBtn = document.getElementById('downloadRec');
    const recDurationEl = document.getElementById('recDuration');
    const volLevel = document.getElementById('volLevel');
    const recPlayer = document.getElementById('recPlayer');
    const recAudio = document.getElementById('recAudio');
    const recMeta = document.getElementById('recMeta');

    startBtn.addEventListener('click', async () => {
      if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        alert('Tu navegador no soporta grabación de audio.');
        return;
      }
      try{
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        recordedChunks = [];
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
        mediaRecorder.ondataavailable = e => { if(e.data.size>0) recordedChunks.push(e.data); };
        mediaRecorder.onstop = async () => {
          const blob = new Blob(recordedChunks, { type: recordedChunks[0]?.type || 'audio/webm' });
          const url = URL.createObjectURL(blob);
          recAudio.src = url;
          recPlayer.style.display = 'block';
          downloadBtn.disabled = false;
          // compute metrics using AudioContext
          try{
            if(!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const arrayBuf = await blob.arrayBuffer();
            const buffer = await audioContext.decodeAudioData(arrayBuf.slice(0));
            const duration = buffer.duration;
            const channelData = buffer.getChannelData(0);
            const rms = calcRMS(channelData);
            recMeta.innerText = `Duración: ${duration.toFixed(2)} s • RMS: ${rms.toFixed(4)}`;
          }catch(err){
            recMeta.innerText = 'No fue posible calcular métricas de audio.';
          }
        };
        mediaRecorder.start();
        startTime = Date.now();
        startBtn.disabled = true;
        stopBtn.disabled = false;
        downloadBtn.disabled = true;
        recPlayer.style.display = 'none';
        recMeta.innerText = '';
        // visualize volume using analyser
        if(!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioContext.createMediaStreamSource(stream);
        analyserNode = audioContext.createAnalyser();
        analyserNode.fftSize = 256;
        source.connect(analyserNode);
        updateMeter();
      }catch(err){
        console.error(err);
        alert('No fue posible acceder al micrófono: ' + (err.message || err));
      }
    });

    stopBtn.addEventListener('click', () => {
      if(mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
      if(rafId) cancelAnimationFrame(rafId);
      let dur = ((Date.now() - startTime)/1000);
      recDurationEl.textContent = dur.toFixed(1);
      startBtn.disabled = false;
      stopBtn.disabled = true;
    });

    downloadBtn.addEventListener('click', ()=>{
      if(recordedChunks.length === 0) return;
      const blob = new Blob(recordedChunks, { type: recordedChunks[0].type });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'speaking-response.webm';
      document.body.appendChild(a);
      a.click();
      a.remove();
    });

    function updateMeter(){
      if(!analyserNode) return;
      const bufferLength = analyserNode.frequencyBinCount;
      const data = new Uint8Array(bufferLength);
      analyserNode.getByteTimeDomainData(data);
      let sum = 0;
      for(let i=0;i<data.length;i++){
        const v = (data[i] - 128) / 128;
        sum += v*v;
      }
      const rms = Math.sqrt(sum / data.length);
      const pct = Math.min(100, Math.round(rms * 200));
      volLevel.style.width = pct + '%';
      if(startTime > 0){
        const dur = ((Date.now() - startTime)/1000);
        recDurationEl.textContent = dur.toFixed(1);
      }
      rafId = requestAnimationFrame(updateMeter);
    }
    function calcRMS(float32Array){
      let sum = 0;
      for(let i=0;i<float32Array.length;i++){ sum += float32Array[i]*float32Array[i]; }
      return Math.sqrt(sum / float32Array.length);
    }

    // ------------- Writing timers and passage display ---------------
    const passageBox = document.getElementById('passageBox');
    const startPassageBtn = document.getElementById('startPassage');
    const passageTimerEl = document.getElementById('passageTimer');
    const writing1 = document.getElementById('writing1');
    const writing1TimerEl = document.getElementById('writing1Timer');

    let passageTimeoutId = null;
    let writing1Interval = null;
    let writing1Remaining = 180; // 3 minutes in seconds
    let passageRemaining = 30;

    startPassageBtn.addEventListener('click', () => {
      // show passage (already shown); start 30s countdown then hide passage and start 3min writing timer
      startPassageBtn.disabled = true;
      passageRemaining = 30;
      passageTimerEl.textContent = formatTime(passageRemaining);
      passageTimeoutId = setInterval(() => {
        passageRemaining--;
        passageTimerEl.textContent = formatTime(passageRemaining);
        if(passageRemaining <= 0){
          clearInterval(passageTimeoutId);
          passageBox.style.display = 'none';
          // start writing timer
          startWriting1Timer();
        }
      }, 1000);
    });

    function startWriting1Timer(){
      writing1Remaining = 180;
      writing1TimerEl.textContent = formatTime(writing1Remaining);
      writing1Interval = setInterval(()=>{
        writing1Remaining--;
        writing1TimerEl.textContent = formatTime(writing1Remaining);
        if(writing1Remaining <= 0){
          clearInterval(writing1Interval);
          writing1.disabled = true;
          writing1TimerEl.textContent = '00:00';
        }
      }, 1000);
    }

    function formatTime(sec){
      const mm = String(Math.floor(sec/60)).padStart(2,'0');
      const ss = String(sec%60).padStart(2,'0');
      return `${mm}:${ss}`;
    }

    // Part 2 writing timer (10 minutes)
    const startWriting2Btn = document.getElementById('startWriting2');
    const writing2TimerEl = document.getElementById('writing2Timer');
    const writing2 = document.getElementById('writing2');
    const wordCountEl = document.getElementById('wordCount');
    const wordStateEl = document.getElementById('wordState');
    let writing2Interval = null;
    let writing2Remaining = 600;

    startWriting2Btn.addEventListener('click', () => {
      startWriting2Btn.disabled = true;
      writing2Remaining = 600;
      writing2TimerEl.textContent = formatTime(writing2Remaining);
      writing2Interval = setInterval(()=>{
        writing2Remaining--;
        writing2TimerEl.textContent = formatTime(writing2Remaining);
        if(writing2Remaining <= 0){
          clearInterval(writing2Interval);
          writing2.disabled = true;
          writing2TimerEl.textContent = '00:00';
        }
      },1000);
    });

    // Word count update for writing2
    writing2.addEventListener('input', () => {
      const words = (writing2.value.trim().match(/\S+/g) || []).length;
      wordCountEl.textContent = words;
      if(words < 75) wordStateEl.textContent = 'Muy corto';
      else if(words > 200) wordStateEl.textContent = 'Muy largo';
      else wordStateEl.textContent = 'OK';
    });

    // --------------- Submit: bundle responses for download -------------
    document.getElementById('submitAll').addEventListener('click', async () => {
      // Gather listening answers (textareas) and note file names if uploaded
      const listening = [];
      for(let i=1;i<=7;i++){
        const fileInput = document.querySelector(`input[data-section="${i}"]`);
        const txt = document.querySelector(`textarea[data-answer="${i}"]`).value || '';
        const attached = fileInput.files[0] ? fileInput.files[0].name : null;
        listening.push({section:i, audioFile: attached, response: txt});
      }

      // writing responses
      const writing1Text = writing1.value || '';
      const writing2Text = writing2.value || '';

      // speaking blob (if any)
      let speakingBlob = null;
      if(recordedChunks.length > 0){
        speakingBlob = new Blob(recordedChunks, { type: recordedChunks[0].type || 'audio/webm' });
      }

      // Prepare JSON manifest
      const manifest = {
        timestamp: (new Date()).toISOString(),
        listening,
        writing:{
          part1: { text: writing1Text },
          part2: { text: writing2Text, words: (writing2Text.trim().match(/\S+/g)||[]).length }
        }
      };

      // Create downloadable files: manifest.json, writing1.txt, writing2.txt, speaking (if exists)
      downloadFile(new Blob([JSON.stringify(manifest, null, 2)], {type:'application/json'}), 'responses-manifest.json');

      downloadFile(new Blob([writing1Text || ''], {type:'text/plain;charset=utf-8'}), 'writing-part1.txt');
      downloadFile(new Blob([writing2Text || ''], {type:'text/plain;charset=utf-8'}), 'writing-part2.txt');

      if(speakingBlob){
        downloadFile(speakingBlob, 'speaking-response.webm');
      }

      // Also prepare simple CSV of listening answers
      const csvLines = ['section,audioFile,response'];
      listening.forEach(l => {
        const safe = (l.response||'').replace(/\r?\n/g,' ').replace(/"/g,'""');
        csvLines.push(`${l.section},"${l.audioFile||''}","${safe}"`);
      });
      downloadFile(new Blob([csvLines.join('\n')], {type:'text/csv'}), 'listening-responses.csv');

      alert('Tus respuestas se han preparado para descarga. Revisa tus descargas (manifest, writing-part1/2, listening-responses y speaking si grabaste).');
    });

    function downloadFile(blob, filename){
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      // revoke after some time
      setTimeout(()=> URL.revokeObjectURL(a.href), 30000);
    }

    // Optional: warn user if leaving page with unsaved content
    window.addEventListener('beforeunload', (e) => {
      // check if there's any content entered
      const any = Array.from(document.querySelectorAll('textarea')).some(t => t.value.trim().length>0)
        || recordedChunks.length>0
        || Array.from(document.querySelectorAll('input[type=file]')).some(fi => fi.files.length>0);
      if(any){
        e.preventDefault();
        e.returnValue = '';
      }
    });
  </script>
</body>
</html>
